{"version":3,"file":"271.8d90ab39474554f1299f.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AAEA,MAAMM,sBAAsB,GAAG,CAA/B;AAEe,MAAMC,UAAN,SAAyBN,gDAAzB,CAA6C;EAgBxDQ,WAAW,CAACC,KAAD,EAAQ;IACf,MAAMA,KAAN;;IADe,sCAkEHC,CAAD,IAAO;MAClB,MAAMC,eAAe,GAAG,KAAKF,KAAL,CAAWG,QAAX,CAAoBC,IAApB,IAA4BX,+FAAkB,CAAC,KAAKO,KAAL,CAAWG,QAAX,CAAoBE,EAArB,CAAtE;MACAJ,CAAC,CAACK,cAAF;MACAC,MAAM,CAACC,QAAP,CAAgBC,IAAhB,GAAuBP,eAAvB;IACH,CAtEkB;;IAAA,sCAwEHQ,IAAD,IAAU;MACrB,MAAMC,QAAQ,GAAGD,IAAI,CAACE,qBAAL,EAAjB;MACA,MAAMC,WAAW,GAAG,KAAKC,SAAL,CAAeC,OAAf,CAAuBC,SAA3C;MACA,MAAMC,cAAc,GAAGJ,WAAW,GAAG,KAAKC,SAAL,CAAeC,OAAf,CAAuBG,aAAvB,CAAqCC,YAA1E;MACA,OACKR,QAAQ,CAACS,GAAT,IAAgBP,WAAhB,IAA+BF,QAAQ,CAACS,GAAT,IAAgBH,cAAhD,IACCN,QAAQ,CAACU,MAAT,IAAmBR,WAAnB,IAAkCF,QAAQ,CAACU,MAAT,IAAmBJ,cADtD,IAECN,QAAQ,CAACS,GAAT,IAAgBP,WAAhB,IAA+BF,QAAQ,CAACU,MAAT,IAAmBJ,cAHvD;IAKH,CAjFkB;;IAAA,uCAmFH,MAAOK,SAAP,IAAqB;MACjC,MAAMC,MAAM,GAAG,4BAAqBD,SAArB,GAAkCP,OAAjD;;MACA,IAAI,CAACQ,MAAL,EAAa;QACT;QACA;MACH,CALgC,CAOjC;MACA;;;MACA,IAAID,SAAS,IAAI1B,sBAAb,IAAuC,CAAC,KAAK4B,YAAL,CAAkBD,MAAlB,CAA5C,EAAuE;QACnE;MACH;;MAED,IAAI,KAAKE,gBAAL,CAAsBH,SAAtB,CAAJ,EAAsC;QAClC;MACH;;MACD,MAAM,KAAKI,QAAL,CAAc,KAAKC,KAAL,CAAWC,GAAzB,EAA8BN,SAA9B,CAAN;MAEA,MAAMZ,IAAI,GAAG,KAAKiB,KAAL,CAAWE,QAAX,CAAoBP,SAApB,CAAb;MACA,MAAMQ,OAAO,GAAGP,MAAM,CAACQ,UAAP,CAAkB,IAAlB,CAAhB;MACA,MAAMC,QAAQ,GAAGtB,IAAI,CAACuB,WAAL,CAAiB,KAAKjC,KAAL,CAAWkC,KAA5B,CAAjB;MAEA,4BAAqBZ,SAArB,GAAkCP,OAAlC,CAA0CoB,MAA1C,GAAmDH,QAAQ,CAACG,MAA5D;MACA,4BAAqBb,SAArB,GAAkCP,OAAlC,CAA0CqB,KAA1C,GAAkDJ,QAAQ,CAACI,KAA3D;MAEA,MAAMC,aAAa,GAAG;QAClBC,aAAa,EAAER,OADG;QAElBE;MAFkB,CAAtB;MAKAtB,IAAI,CAAC6B,MAAL,CAAYF,aAAZ;MACA,KAAKZ,gBAAL,CAAsBH,SAAtB,IAAmC,IAAnC;IACH,CAnHkB;;IAAA,wCAqHF,MAAM;MACnB,qJAAqBkB,IAArB,CAA2BC,KAAD,IAAW;QACjCA,KAAK,CAACC,aAAN,GAAsB,IAAtB;QACAD,KAAK,CAACE,WAAN,CAAkB,KAAK3C,KAAL,CAAW4C,OAA7B,EAAsCJ,IAAtC,CAA2C,KAAKK,cAAhD,EAAgEC,KAAhE,CAAsE,KAAKC,mBAA3E;MACH,CAHD;IAIH,CA1HkB;;IAAA,wCA4HDnB,GAAD,IAAS;MACtB,KAAKoB,QAAL,CAAc;QAACpB,GAAD;QAAMqB,QAAQ,EAAErB,GAAG,CAACqB;MAApB,CAAd;;MACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGtB,GAAG,CAACqB,QAAxB,EAAkCC,CAAC,EAAnC,EAAuC;QACnC,4BAAqBA,CAArB,kBAA4B3D,4CAAA,EAA5B;MACH;;MACD,KAAKyD,QAAL,CAAc;QAACI,OAAO,EAAE,KAAV;QAAiBC,OAAO,EAAE;MAA1B,CAAd;IACH,CAlIkB;;IAAA,6CAoIIC,MAAD,IAAY;MAC9BC,OAAO,CAACC,GAAR,CAAY,iCAAiCF,MAA7C,EAD8B,CACwB;;MACtD,KAAKN,QAAL,CAAc;QAACI,OAAO,EAAE,KAAV;QAAiBC,OAAO,EAAE;MAA1B,CAAd;IACH,CAvIkB;;IAAA,kCAyIR,OAAOzB,GAAP,EAAYN,SAAZ,KAA0B;MACjC,IAAI,KAAKK,KAAL,CAAW8B,cAAX,CAA0BnC,SAA1B,CAAJ,EAA0C;QACtC,OAAO,KAAKK,KAAL,CAAWE,QAAX,CAAoBP,SAApB,CAAP;MACH;;MAED,MAAMZ,IAAI,GAAG,MAAMkB,GAAG,CAAC8B,OAAJ,CAAYpC,SAAS,GAAG,CAAxB,CAAnB;MAEA,MAAMO,QAAQ,GAAG8B,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKjC,KAAL,CAAWE,QAA7B,CAAjB;MACAA,QAAQ,CAACnB,IAAI,CAACY,SAAN,CAAR,GAA2BZ,IAA3B;MAEA,MAAM+C,cAAc,GAAGE,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKjC,KAAL,CAAW8B,cAA7B,CAAvB;MACAA,cAAc,CAAC/C,IAAI,CAACY,SAAN,CAAd,GAAiC,IAAjC;MAEA,KAAK0B,QAAL,CAAc;QAACnB,QAAD;QAAW4B;MAAX,CAAd;MAEA,OAAO/C,IAAP;IACH,CAzJkB;;IAAA,sCA2JJlB,sDAAQ,CAAC,MAAM;MAC1B,IAAI,KAAKmC,KAAL,CAAW0B,OAAf,EAAwB;QACpB,KAAK,IAAIH,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKvB,KAAL,CAAWsB,QAA/B,EAAyCC,CAAC,EAA1C,EAA8C;UAC1C,KAAKW,aAAL,CAAmBX,CAAnB;QACH;MACJ;IACJ,CANsB,EAMpB,GANoB,CA3JJ;;IAGf,KAAKzB,gBAAL,GAAwB,EAAxB;IACA,KAAKX,SAAL,gBAAiBvB,4CAAA,EAAjB;IAEA,KAAKoC,KAAL,GAAa;MACTC,GAAG,EAAE,IADI;MAETC,QAAQ,EAAE,EAFD;MAGT4B,cAAc,EAAE,EAHP;MAITR,QAAQ,EAAE,CAJD;MAKTG,OAAO,EAAE,IALA;MAMTC,OAAO,EAAE;IANA,CAAb;EAQH;;EAEDS,iBAAiB,GAAG;IAChB,KAAKC,cAAL;;IACA,IAAI,KAAKjD,SAAL,CAAeC,OAAnB,EAA4B;MACxB,KAAKiD,UAAL,GAAkB,KAAKlD,SAAL,CAAeC,OAAf,CAAuBG,aAAvB,CAAqCA,aAAvD;MACA,KAAK8C,UAAL,CAAgBC,gBAAhB,CAAiC,QAAjC,EAA2C,KAAKC,YAAhD;IACH;EACJ;;EAEDC,oBAAoB,GAAG;IACnB,IAAI,KAAKH,UAAT,EAAqB;MACjB,KAAKA,UAAL,CAAgBI,mBAAhB,CAAoC,QAApC,EAA8C,KAAKF,YAAnD;IACH;EACJ;;EAE8B,OAAxBG,wBAAwB,CAACrE,KAAD,EAAQ2B,KAAR,EAAe;IAC1C,IAAI3B,KAAK,CAAC4C,OAAN,KAAkBjB,KAAK,CAAC2C,WAA5B,EAAyC;MACrC,OAAO;QACH1C,GAAG,EAAE,IADF;QAEHC,QAAQ,EAAE,EAFP;QAGH4B,cAAc,EAAE,EAHb;QAIHR,QAAQ,EAAE,CAJP;QAKHG,OAAO,EAAE,IALN;QAMHC,OAAO,EAAE,KANN;QAOHiB,WAAW,EAAEtE,KAAK,CAAC4C;MAPhB,CAAP;IASH;;IACD,OAAO,IAAP;EACH;;EAED2B,kBAAkB,CAACC,SAAD,EAAYC,SAAZ,EAAuB;IACrC,IAAI,KAAKzE,KAAL,CAAW4C,OAAX,KAAuB4B,SAAS,CAAC5B,OAArC,EAA8C;MAC1C,KAAKmB,cAAL;MACA,KAAKtC,gBAAL,GAAwB,EAAxB;IACH;;IACD,IAAI,KAAKzB,KAAL,CAAWkC,KAAX,KAAqBsC,SAAS,CAACtC,KAAnC,EAA0C;MACtC,KAAKT,gBAAL,GAAwB,EAAxB;;MACA,IAAI,KAAKE,KAAL,CAAW0B,OAAf,EAAwB;QACpB,KAAK,IAAIH,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKvB,KAAL,CAAWsB,QAA/B,EAAyCC,CAAC,EAA1C,EAA8C;UAC1C,KAAKW,aAAL,CAAmBX,CAAnB;QACH;MACJ;IACJ;;IAED,IAAI,CAACuB,SAAS,CAACpB,OAAX,IAAsB,KAAK1B,KAAL,CAAW0B,OAArC,EAA8C;MAC1C,KAAK,IAAIH,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKvB,KAAL,CAAWsB,QAA/B,EAAyCC,CAAC,EAA1C,EAA8C;QAC1C,KAAKW,aAAL,CAAmBX,CAAnB;MACH;IACJ;EACJ;;EAmGDX,MAAM,GAAG;IACL,IAAI,KAAKZ,KAAL,CAAWyB,OAAf,EAAwB;MACpB,oBACI;QACI,GAAG,EAAE,KAAKtC,SADd;QAEI,SAAS,EAAC;MAFd,gBAII,iDAAC,2FAAD,OAJJ,CADJ;IAQH;;IAED,IAAI,CAAC,KAAKa,KAAL,CAAW0B,OAAhB,EAAyB;MACrB,oBACI,iDAAC,6EAAD;QACI,QAAQ,EAAE,KAAKrD,KAAL,CAAWG,QADzB;QAEI,OAAO,EAAE,KAAKH,KAAL,CAAW4C;MAFxB,EADJ;IAMH;;IAED,MAAM8B,WAAW,GAAG,EAApB;;IACA,KAAK,IAAIxB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKvB,KAAL,CAAWsB,QAA/B,EAAyCC,CAAC,EAA1C,EAA8C;MAC1CwB,WAAW,CAACC,IAAZ,eACI;QACI,GAAG,EAAE,4BAAqBzB,CAArB,EADT;QAEI,GAAG,EAAE,qBAAqBA;MAF9B,EADJ;;MAOA,IAAIA,CAAC,GAAG,KAAKvB,KAAL,CAAWsB,QAAX,GAAsB,CAA1B,IAA+B,KAAKtB,KAAL,CAAWsB,QAAX,GAAsB,CAAzD,EAA4D;QACxDyB,WAAW,CAACC,IAAZ,eACI;UACI,GAAG,EAAE,qBAAqBzB,CAD9B;UAEI,SAAS,EAAC;QAFd,EADJ;MAMH;IACJ;;IAED,oBACI;MACI,GAAG,EAAE,KAAKpC,SADd;MAEI,SAAS,EAAC,WAFd;MAGI,OAAO,EAAE,KAAKd,KAAL,CAAW4E;IAHxB,GAKKF,WALL,CADJ;EASH;;AApOuD;;gBAAvC7E,yBACE;EAEf;AACR;AACA;EACQM,QAAQ,EAAEb,qEALK;;EAOf;AACR;AACA;EACQsD,OAAO,EAAEtD,qEAVM;EAWf4C,KAAK,EAAE5C,qEAXQ;EAYfsF,aAAa,EAAEtF,mEAAyBwF;AAZzB","sources":["webpack://@mattermost/webapp/./components/pdf_preview.jsx"],"sourcesContent":["// Copyright (c) 2015-present Mattermost, Inc. All Rights Reserved.\n// See LICENSE.txt for license information.\n\nimport PropTypes from 'prop-types';\nimport React from 'react';\nimport debounce from 'lodash/debounce';\n\nimport {getFileDownloadUrl} from 'mattermost-redux/utils/file_utils';\n\nimport LoadingSpinner from 'components/widgets/loading/loading_spinner';\nimport FileInfoPreview from 'components/file_info_preview';\n\nconst INITIAL_RENDERED_PAGES = 3;\n\nexport default class PDFPreview extends React.PureComponent {\n    static propTypes = {\n\n        /**\n        * Compare file types\n        */\n        fileInfo: PropTypes.object.isRequired,\n\n        /**\n        *  URL of pdf file to output and compare to update props url\n        */\n        fileUrl: PropTypes.string.isRequired,\n        scale: PropTypes.number.isRequired,\n        handleBgClose: PropTypes.func.isRequired,\n    }\n\n    constructor(props) {\n        super(props);\n\n        this.pdfPagesRendered = {};\n        this.container = React.createRef();\n\n        this.state = {\n            pdf: null,\n            pdfPages: {},\n            pdfPagesLoaded: {},\n            numPages: 0,\n            loading: true,\n            success: false,\n        };\n    }\n\n    componentDidMount() {\n        this.getPdfDocument();\n        if (this.container.current) {\n            this.parentNode = this.container.current.parentElement.parentElement;\n            this.parentNode.addEventListener('scroll', this.handleScroll);\n        }\n    }\n\n    componentWillUnmount() {\n        if (this.parentNode) {\n            this.parentNode.removeEventListener('scroll', this.handleScroll);\n        }\n    }\n\n    static getDerivedStateFromProps(props, state) {\n        if (props.fileUrl !== state.prevFileUrl) {\n            return {\n                pdf: null,\n                pdfPages: {},\n                pdfPagesLoaded: {},\n                numPages: 0,\n                loading: true,\n                success: false,\n                prevFileUrl: props.fileUrl,\n            };\n        }\n        return null;\n    }\n\n    componentDidUpdate(prevProps, prevState) {\n        if (this.props.fileUrl !== prevProps.fileUrl) {\n            this.getPdfDocument();\n            this.pdfPagesRendered = {};\n        }\n        if (this.props.scale !== prevProps.scale) {\n            this.pdfPagesRendered = {};\n            if (this.state.success) {\n                for (let i = 0; i < this.state.numPages; i++) {\n                    this.renderPDFPage(i);\n                }\n            }\n        }\n\n        if (!prevState.success && this.state.success) {\n            for (let i = 0; i < this.state.numPages; i++) {\n                this.renderPDFPage(i);\n            }\n        }\n    }\n\n    downloadFile = (e) => {\n        const fileDownloadUrl = this.props.fileInfo.link || getFileDownloadUrl(this.props.fileInfo.id);\n        e.preventDefault();\n        window.location.href = fileDownloadUrl;\n    }\n\n    isInViewport = (page) => {\n        const bounding = page.getBoundingClientRect();\n        const viewportTop = this.container.current.scrollTop;\n        const viewportBottom = viewportTop + this.container.current.parentElement.clientHeight;\n        return (\n            (bounding.top >= viewportTop && bounding.top <= viewportBottom) ||\n            (bounding.bottom >= viewportTop && bounding.bottom <= viewportBottom) ||\n            (bounding.top <= viewportTop && bounding.bottom >= viewportBottom)\n        );\n    };\n\n    renderPDFPage = async (pageIndex) => {\n        const canvas = this[`pdfCanvasRef-${pageIndex}`].current;\n        if (!canvas) {\n            // Refs are undefined when testing\n            return;\n        }\n\n        // Always render the first INITIAL_RENDERED_PAGES pages to avoid\n        // problems detecting isInViewport during the open animation\n        if (pageIndex >= INITIAL_RENDERED_PAGES && !this.isInViewport(canvas)) {\n            return;\n        }\n\n        if (this.pdfPagesRendered[pageIndex]) {\n            return;\n        }\n        await this.loadPage(this.state.pdf, pageIndex);\n\n        const page = this.state.pdfPages[pageIndex];\n        const context = canvas.getContext('2d');\n        const viewport = page.getViewport(this.props.scale);\n\n        this[`pdfCanvasRef-${pageIndex}`].current.height = viewport.height;\n        this[`pdfCanvasRef-${pageIndex}`].current.width = viewport.width;\n\n        const renderContext = {\n            canvasContext: context,\n            viewport,\n        };\n\n        page.render(renderContext);\n        this.pdfPagesRendered[pageIndex] = true;\n    }\n\n    getPdfDocument = () => {\n        import('pdfjs-dist').then((PDFJS) => {\n            PDFJS.disableWorker = true;\n            PDFJS.getDocument(this.props.fileUrl).then(this.onDocumentLoad).catch(this.onDocumentLoadError);\n        });\n    }\n\n    onDocumentLoad = (pdf) => {\n        this.setState({pdf, numPages: pdf.numPages});\n        for (let i = 0; i < pdf.numPages; i++) {\n            this[`pdfCanvasRef-${i}`] = React.createRef();\n        }\n        this.setState({loading: false, success: true});\n    }\n\n    onDocumentLoadError = (reason) => {\n        console.log('Unable to load PDF preview: ' + reason); //eslint-disable-line no-console\n        this.setState({loading: false, success: false});\n    }\n\n    loadPage = async (pdf, pageIndex) => {\n        if (this.state.pdfPagesLoaded[pageIndex]) {\n            return this.state.pdfPages[pageIndex];\n        }\n\n        const page = await pdf.getPage(pageIndex + 1);\n\n        const pdfPages = Object.assign({}, this.state.pdfPages);\n        pdfPages[page.pageIndex] = page;\n\n        const pdfPagesLoaded = Object.assign({}, this.state.pdfPagesLoaded);\n        pdfPagesLoaded[page.pageIndex] = true;\n\n        this.setState({pdfPages, pdfPagesLoaded});\n\n        return page;\n    }\n\n    handleScroll = debounce(() => {\n        if (this.state.success) {\n            for (let i = 0; i < this.state.numPages; i++) {\n                this.renderPDFPage(i);\n            }\n        }\n    }, 100)\n\n    render() {\n        if (this.state.loading) {\n            return (\n                <div\n                    ref={this.container}\n                    className='view-image__loading'\n                >\n                    <LoadingSpinner/>\n                </div>\n            );\n        }\n\n        if (!this.state.success) {\n            return (\n                <FileInfoPreview\n                    fileInfo={this.props.fileInfo}\n                    fileUrl={this.props.fileUrl}\n                />\n            );\n        }\n\n        const pdfCanvases = [];\n        for (let i = 0; i < this.state.numPages; i++) {\n            pdfCanvases.push(\n                <canvas\n                    ref={this[`pdfCanvasRef-${i}`]}\n                    key={'previewpdfcanvas' + i}\n                />,\n            );\n\n            if (i < this.state.numPages - 1 && this.state.numPages > 1) {\n                pdfCanvases.push(\n                    <div\n                        key={'previewpdfspacer' + i}\n                        className='pdf-preview-spacer'\n                    />,\n                );\n            }\n        }\n\n        return (\n            <div\n                ref={this.container}\n                className='post-code'\n                onClick={this.props.handleBgClose}\n            >\n                {pdfCanvases}\n            </div>\n        );\n    }\n}\n"],"names":["PropTypes","React","debounce","getFileDownloadUrl","LoadingSpinner","FileInfoPreview","INITIAL_RENDERED_PAGES","PDFPreview","PureComponent","constructor","props","e","fileDownloadUrl","fileInfo","link","id","preventDefault","window","location","href","page","bounding","getBoundingClientRect","viewportTop","container","current","scrollTop","viewportBottom","parentElement","clientHeight","top","bottom","pageIndex","canvas","isInViewport","pdfPagesRendered","loadPage","state","pdf","pdfPages","context","getContext","viewport","getViewport","scale","height","width","renderContext","canvasContext","render","then","PDFJS","disableWorker","getDocument","fileUrl","onDocumentLoad","catch","onDocumentLoadError","setState","numPages","i","createRef","loading","success","reason","console","log","pdfPagesLoaded","getPage","Object","assign","renderPDFPage","componentDidMount","getPdfDocument","parentNode","addEventListener","handleScroll","componentWillUnmount","removeEventListener","getDerivedStateFromProps","prevFileUrl","componentDidUpdate","prevProps","prevState","pdfCanvases","push","handleBgClose","object","isRequired","string","number","func"],"sourceRoot":""}